<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ZARUverse | Mint & Claim</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@latest/dist/umd/index.min.js"></script>
  <script src="https://unpkg.com/web3modal@latest/dist/index.js"></script>
</head>

<body class="bg-dark text-light">
  <div class="container py-5">
    <h1 class="display-5 fw-bold text-center mb-1">ü™ô ZARU Mint & Claim</h1>
    <p class="text-center text-secondary mb-4">Mint tokens, claim with NFT, or buy directly.</p>

    <div class="text-center mb-4">
      <button class="btn btn-warning btn-lg" id="connectWallet">üîó Connect Wallet</button>
      <p id="walletAddress" class="mt-3 small"></p>
    </div>

    <!-- Token info -->
    <div id="tokenInfo" class="row g-3 justify-content-center" style="display:none;">
      <div class="col-md-3">
        <div class="card bg-secondary border-0">
          <div class="card-body">
            <div class="small text-uppercase text-muted">Token</div>
            <div id="tokenMeta" class="fw-semibold">‚Äî</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-secondary border-0">
          <div class="card-body">
            <div class="small text-uppercase text-muted">Your balance</div>
            <div id="userBalance" class="fw-semibold">‚Äî</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-secondary border-0">
          <div class="card-body">
            <div class="small text-uppercase text-muted">Total supply</div>
            <div id="totalSupply" class="fw-semibold">‚Äî</div>
          </div>
        </div>
      </div>
    </div>

    <hr class="my-4">

    <!-- Mint -->
    <div id="mintArea" style="display:none;">
      <h3 class="h5 mb-3">üõ†Ô∏è Mint ZARU (owner only, typically)</h3>
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label for="mintAmount" class="form-label">Amount (in ZARU):</label>
          <input type="number" class="form-control" id="mintAmount" placeholder="e.g. 1000" min="0" step="any">
        </div>
        <div class="col-md-3 d-grid">
          <button class="btn btn-success" id="mintBtn">Mint</button>
        </div>
      </div>
      <p class="text-muted small mt-2">Note: If this reverts, the function may be restricted to the owner.</p>
    </div>

    <hr class="my-4">

    <!-- Claim with NFT -->
    <div id="claimArea" style="display:none;">
      <h3 class="h5 mb-3">üéüÔ∏è Claim with NFT</h3>
      <div class="d-grid d-md-inline-flex gap-2">
        <button class="btn btn-primary" id="claimWithNFTBtn">Claim with NFT</button>
      </div>
      <p class="text-muted small mt-2">Requires holding the eligible NFT for claim unlocks.</p>
    </div>

    <hr class="my-4">

    <!-- Buy with BNB -->
    <div id="buyArea" style="display:none;">
      <h3 class="h5 mb-3">üí≥ Buy ZARU (BNB ‚Üí ZARU)</h3>
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label for="buyValue" class="form-label">Amount (BNB):</label>
          <input type="number" class="form-control" id="buyValue" placeholder="e.g. 0.1" min="0" step="any">
        </div>
        <div class="col-md-3 d-grid">
          <button class="btn btn-outline-light" id="buyBtn">Buy</button>
        </div>
      </div>
      <p class="text-muted small mt-2">Sends BNB as msg.value to the contract‚Äôs buy() function.</p>
    </div>

    <p id="statusMsg" class="mt-4 text-center"></p>
  </div>

  <script>
    // ZARU token on BSC
    const zaruTokenAddress = "0xdac6f0ec5901b3877dc6db23c3882267ba9fabf6";

    // Minimal ABI covering used functions (ERC-20 views + custom)
    const zaruTokenABI = [
      // ERC-20 views
      {"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},

      // Custom functions from your contract
      {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"mint","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"claimWithNFT","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"buy","outputs":[],"stateMutability":"payable","type":"function"}
    ];

    let web3;
    let userAddress;
    let zaruContract;
    let tokenDecimals = 18;
    let tokenSymbol = "ZARU";
    let tokenName = "ZARU";

    function setStatus(msg) {
      const el = document.getElementById("statusMsg");
      el.innerText = msg || "";
    }

    function fromWeiDecimals(value) {
      // Convert using token decimals (not necessarily 18)
      return Number(value) / (10 ** tokenDecimals);
    }

    function toWeiDecimals(amountStr) {
      const num = Number(amountStr || "0");
      if (isNaN(num) || num <= 0) return "0";
      // Use BigInt to avoid precision issues
      const mul = BigInt(10) ** BigInt(tokenDecimals);
      return (BigInt(Math.trunc(num * 1e6)) * (mul / BigInt(1e6))).toString();
    }

    async function connectWallet() {
      try {
        const providerOptions = {
          walletconnect: {
            package: window.WalletConnectProvider,
            options: { rpc: { 56: "https://bsc-dataseed.binance.org/" } }
          }
        };
        const web3Modal = new window.Web3Modal.default({ cacheProvider: false, providerOptions });
        const instance = await web3Modal.connect();
        web3 = new Web3(instance);

        const accounts = await web3.eth.getAccounts();
        userAddress = accounts[0];
        zaruContract = new web3.eth.Contract(zaruTokenABI, zaruTokenAddress);

        document.getElementById("walletAddress").innerText = `Connected: ${userAddress}`;
        document.getElementById("tokenInfo").style.display = "flex";
        document.getElementById("mintArea").style.display = "block";
        document.getElementById("claimArea").style.display = "block";
        document.getElementById("buyArea").style.display = "block";

        await loadTokenMeta();
        await refreshBalances();

        // Optional: refresh on new blocks
        if (instance.on) {
          instance.on("accountsChanged", async (accs) => {
            userAddress = accs[0];
            document.getElementById("walletAddress").innerText = `Connected: ${userAddress}`;
            await refreshBalances();
          });
          instance.on("chainChanged", async () => {
            await refreshBalances();
          });
        }
      } catch (err) {
        console.error(err);
        setStatus("‚ùå Wallet connection failed.");
      }
    }

    async function loadTokenMeta() {
      try {
        tokenName = await zaruContract.methods.name().call();
        tokenSymbol = await zaruContract.methods.symbol().call();
        tokenDecimals = parseInt(await zaruContract.methods.decimals().call());
      } catch (e) {
        console.warn("Could not fetch name/symbol/decimals, using defaults.");
      }
      document.getElementById("tokenMeta").innerText = `${tokenName} (${tokenSymbol}) ‚Ä¢ ${tokenDecimals} decimals`;
    }

    async function refreshBalances() {
      try {
        const [rawBal, rawSupply] = await Promise.all([
          zaruContract.methods.balanceOf(userAddress).call(),
          zaruContract.methods.totalSupply().call()
        ]);
        document.getElementById("userBalance").innerText = `${fromWeiDecimals(rawBal)} ${tokenSymbol}`;
        document.getElementById("totalSupply").innerText = `${fromWeiDecimals(rawSupply)} ${tokenSymbol}`;
      } catch (e) {
        console.error(e);
      }
    }

    async function mintTokens() {
      const amount = document.getElementById("mintAmount").value;
      if (!amount || Number(amount) <= 0) return alert("‚ùå Enter a valid amount");

      setStatus("‚è≥ Minting...");
      try {
        const amountWei = toWeiDecimals(amount);
        await zaruContract.methods.mint(amountWei).send({ from: userAddress });
        setStatus("‚úÖ Minted successfully!");
        await refreshBalances();
      } catch (err) {
        console.error(err);
        setStatus("‚ùå Mint failed. (Owner-only or reverted)");
      }
    }

    async function claimWithNFT() {
      setStatus("‚è≥ Claiming with NFT...");
      try {
        await zaruContract.methods.claimWithNFT().send({ from: userAddress });
        setStatus("‚úÖ Claimed successfully!");
        await refreshBalances();
      } catch (err) {
        console.error(err);
        setStatus("‚ùå Claim failed.");
      }
    }

    async function buyTokens() {
      const bnb = document.getElementById("buyValue").value;
      if (!bnb || Number(bnb) <= 0) return alert("‚ùå Enter BNB amount");

      setStatus("‚è≥ Buying...");
      try {
        const valueWei = web3.utils.toWei(bnb.toString(), "ether");
        await zaruContract.methods.buy().send({ from: userAddress, value: valueWei });
        setStatus("‚úÖ Purchase successful!");
        await refreshBalances();
      } catch (err) {
        console.error(err);
        setStatus("‚ùå Purchase failed.");
      }
    }

    // Events
    document.getElementById("connectWallet").addEventListener("click", connectWallet);
    document.getElementById("mintBtn").addEventListener("click", mintTokens);
    document.getElementById("claimWithNFTBtn").addEventListener("click", claimWithNFT);
    document.getElementById("buyBtn").addEventListener("click", buyTokens);
  </script>
</body>
</html>
